<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Quick Quiz AI</title>
    <script src="problems.js" onerror="console.log('problems.js not found, using empty DB')"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{
            --bk:#0d0d0f;--dk:#1c1c22;--mid:#6b6b7a;--soft:#9999aa;
            --ln:#e4e4ec;--ft:#f4f4f8;--wh:#ffffff;
            --ac:#6c63ff;--ac2:#9d97ff;--ac-bg:#f0efff;
            --grn:#00c97a;--grn-bg:#e6faf3;--red:#ff4757;--red-bg:#fff1f2;
            --fd:'Syne',sans-serif;--fb:'Noto Sans JP',sans-serif;--fm:'DM Mono',monospace;
            --glow:0 0 24px rgba(108,99,255,.18);
            --shadow-sm:0 2px 8px rgba(13,13,15,.08);
            --shadow-md:0 8px 32px rgba(13,13,15,.12);
        }
        body{font-family:var(--fb);background:#f7f7fb;color:var(--bk);min-height:100vh;
            -webkit-user-select:none;user-select:none;touch-action:manipulation;overflow-x:hidden}

        .shell{max-width:480px;margin:0 auto;padding:0 20px;min-height:100vh}
        .header{padding:40px 0 12px;position:relative}
        .header-logo{font-family:var(--fd);font-weight:800;font-size:32px;letter-spacing:-.04em;line-height:1;display:flex;align-items:center;gap:10px}
        .header-logo .ai{display:inline-flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            font-size:10px;font-weight:700;letter-spacing:.12em;padding:4px 10px;border-radius:6px;
            box-shadow:var(--glow);position:relative;top:-1px}
        .header-sub{font-family:var(--fm);font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--soft);margin-top:8px}
        .header-line{width:100%;height:1px;background:linear-gradient(90deg,var(--ac) 0%,var(--ln) 60%);margin-top:18px;opacity:.6}

        .screen{animation:si .4s cubic-bezier(.22,1,.36,1)}
        @keyframes si{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        .hidden{display:none!important}

        .label{font-family:var(--fm);font-size:10px;font-weight:500;letter-spacing:.18em;text-transform:uppercase;color:var(--soft);margin-bottom:16px}
        .label-lg{font-family:var(--fd);font-size:20px;font-weight:700;letter-spacing:-.02em;margin-bottom:6px}
        .label-desc{font-size:13px;color:var(--mid);line-height:1.5;margin-bottom:20px}

        /* Subject list */
        .subj-grid{display:flex;flex-direction:column}
        .subj-item{display:flex;align-items:center;gap:16px;padding:18px 16px;margin-bottom:8px;
            border-radius:16px;background:var(--wh);box-shadow:var(--shadow-sm);
            border:1.5px solid transparent;
            cursor:pointer;transition:all .2s cubic-bezier(.22,1,.36,1);
            width:100%;text-align:left;font-family:var(--fb);color:var(--bk)}
        .subj-item:hover{border-color:var(--ac);box-shadow:var(--glow),var(--shadow-md);transform:translateY(-2px)}
        .subj-item:active{transform:translateY(0);opacity:.85}
        .subj-icon{width:48px;height:48px;border-radius:12px;
            background:linear-gradient(135deg,var(--ac-bg),var(--ft));
            display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;transition:all .2s}
        .subj-item:hover .subj-icon{background:linear-gradient(135deg,var(--ac),var(--ac2))}
        .subj-item:hover .subj-icon span{filter:brightness(10) saturate(0)}
        .subj-text{font-weight:600;font-size:16px;letter-spacing:-.01em}
        .subj-arrow{margin-left:auto;font-size:18px;color:var(--soft);transition:all .2s}
        .subj-item:hover .subj-arrow{transform:translateX(4px);color:var(--ac)}

        /* Overlay */
        .overlay{display:none;position:fixed;inset:0;background:rgba(247,247,251,.96);backdrop-filter:blur(24px);
            -webkit-backdrop-filter:blur(24px);z-index:100;overflow-y:auto}
        .overlay.show{display:block;animation:fi .2s ease}
        @keyframes fi{from{opacity:0}to{opacity:1}}
        .overlay-inner{max-width:480px;margin:0 auto;padding:40px 20px 60px;animation:su .3s cubic-bezier(.22,1,.36,1)}
        @keyframes su{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

        /* Category list */
        .cat-list{display:flex;flex-direction:column}
        .cat-item{display:flex;align-items:center;padding:13px 12px;margin-bottom:4px;border-radius:10px;
            border:1.5px solid transparent;background:var(--wh);
            cursor:pointer;font-family:var(--fb);font-size:14px;font-weight:500;color:var(--dk);transition:all .15s}
        .cat-item:hover{background:var(--ac-bg);border-color:var(--ac2)}
        .cat-item::before{content:'';width:18px;height:18px;border:2px solid var(--ln);border-radius:5px;
            margin-right:14px;flex-shrink:0;transition:all .15s}
        .cat-item.active::before{background:var(--ac);border-color:var(--ac);box-shadow:inset 0 0 0 2px var(--wh)}
        .cat-item.active{color:var(--bk);font-weight:600;background:var(--ac-bg);border-color:var(--ac2)}
        .grade-div{font-family:var(--fm);font-size:9px;font-weight:500;letter-spacing:.2em;text-transform:uppercase;color:var(--soft);padding:18px 0 6px}

        /* Buttons */
        .btn{font-family:var(--fd);font-weight:700;font-size:14px;letter-spacing:.02em;padding:14px 32px;border:none;border-radius:12px;cursor:pointer;transition:all .2s}
        .btn-bk{background:linear-gradient(135deg,var(--bk),#2d2d3a);color:var(--wh);box-shadow:var(--shadow-md)}
        .btn-bk:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(13,13,15,.2)}
        .btn-bk:disabled{background:var(--ln);color:var(--soft);cursor:default;transform:none;box-shadow:none}
        .btn-ol{background:transparent;color:var(--mid);border:1.5px solid var(--ln);border-radius:12px}
        .btn-ol:hover{border-color:var(--ac);color:var(--ac)}
        .btn-full{width:100%}
        .back-link{font-family:var(--fm);font-size:11px;letter-spacing:.1em;color:var(--soft);cursor:pointer;background:none;border:none;padding:12px 0;transition:color .15s}
        .back-link:hover{color:var(--ac)}

        /* Stats */
        .stats-row{display:grid;grid-template-columns:repeat(3,1fr);background:var(--wh);border:1.5px solid var(--ln);border-radius:16px;overflow:hidden;margin:20px 0;box-shadow:var(--shadow-sm)}
        .stat-cell{padding:16px 8px;text-align:center;border-right:1px solid var(--ln)}
        .stat-cell:last-child{border-right:none}
        .stat-num{font-family:var(--fd);font-size:28px;font-weight:800;letter-spacing:-.03em}
        .stat-label{font-family:var(--fm);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--soft);margin-top:4px}

        /* Mode (quiz mode toggle) */
        .mode-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0}
        .mode-btn{background:var(--wh);border:1.5px solid var(--ln);border-radius:10px;padding:12px;font-family:var(--fb);
            font-size:13px;font-weight:500;color:var(--mid);cursor:pointer;transition:all .15s;text-align:center;box-shadow:var(--shadow-sm)}
        .mode-btn.active{background:var(--ac-bg);border-color:var(--ac);color:var(--ac);font-weight:700}

        /* Quiz overlay */
        .quiz-ov{display:none;position:fixed;inset:0;background:#f7f7fb;z-index:200;overflow-y:auto}
        .quiz-ov.show{display:block;animation:fi .2s ease}
        .quiz-in{max-width:480px;margin:0 auto;padding:32px 20px 100px;animation:su .3s cubic-bezier(.22,1,.36,1)}
        .quiz-cnt{font-family:var(--fm);font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--ac);margin-bottom:20px;
            display:flex;align-items:center;gap:6px}
        .quiz-cnt::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--ac);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
        .quiz-q{font-family:var(--fd);font-size:20px;font-weight:700;letter-spacing:-.02em;line-height:1.5;margin-bottom:28px}
        .quiz-opts{display:flex;flex-direction:column;gap:10px}
        .quiz-opt{display:flex;align-items:center;gap:14px;padding:16px 18px;
            border:1.5px solid var(--ln);border-radius:14px;background:var(--wh);
            cursor:pointer;font-family:var(--fb);font-size:15px;font-weight:500;color:var(--dk);
            transition:all .18s cubic-bezier(.22,1,.36,1);width:100%;text-align:left;
            box-shadow:var(--shadow-sm)}
        .quiz-opt:hover{border-color:var(--ac);box-shadow:var(--glow),var(--shadow-md);transform:translateX(4px)}
        .quiz-opt:active{transform:translateX(2px);opacity:.85}
        .quiz-let{width:30px;height:30px;border-radius:8px;background:var(--ft);display:flex;align-items:center;
            justify-content:center;font-family:var(--fm);font-size:12px;font-weight:500;color:var(--mid);flex-shrink:0;transition:all .18s}
        .quiz-opt:hover .quiz-let{background:var(--ac);color:var(--wh)}
        .quiz-res{margin-top:24px;padding:20px;border-radius:16px;font-size:14px;line-height:1.75;font-weight:500;
            border:1.5px solid var(--ln);background:var(--ft);color:var(--mid);min-height:60px;transition:all .3s}
        .quiz-res.ok{border-color:var(--grn);background:var(--grn-bg);color:#0a6644;
            box-shadow:0 4px 20px rgba(0,201,122,.12)}
        .quiz-res.ng{border-color:var(--red);background:var(--red-bg);color:#9b1625;
            box-shadow:0 4px 20px rgba(255,71,87,.12)}
        .quiz-acts{display:flex;gap:10px;margin-top:20px}
        .quiz-acts .btn{flex:1;text-align:center}

        /* Chat */
        .chat-bd{display:none;position:fixed;inset:0;background:rgba(13,13,15,.3);backdrop-filter:blur(4px);z-index:299}
        .chat-bd.show{display:block}
        .chat-pn{display:none;position:fixed;bottom:0;left:0;right:0;z-index:300;
            background:var(--wh);border-top:2px solid var(--ac);max-height:82vh;
            box-shadow:0 -8px 40px rgba(108,99,255,.15)}
        .chat-pn.show{display:flex;flex-direction:column;animation:ci .35s cubic-bezier(.22,1,.36,1)}
        @keyframes ci{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .chat-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--ln);flex-shrink:0}
        .chat-tt{font-family:var(--fd);font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
        .chat-tt::before{content:'';width:8px;height:8px;border-radius:50%;background:var(--ac);
            box-shadow:0 0 8px var(--ac);animation:pulse 2s infinite}
        .chat-x{width:30px;height:30px;border-radius:50%;background:var(--ft);border:none;font-size:16px;
            cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--mid);transition:all .15s}
        .chat-x:hover{background:var(--bk);color:var(--wh)}
        .chat-ms{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:10px;min-height:100px;max-height:40vh}
        .chat-m{max-width:85%;padding:12px 16px;font-size:13px;line-height:1.7;word-break:break-word;border-radius:16px}
        .chat-m.u{background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            align-self:flex-end;border-bottom-right-radius:4px;box-shadow:var(--glow)}
        .chat-m.a{background:var(--ft);color:var(--dk);align-self:flex-start;border-bottom-left-radius:4px;border:1px solid var(--ln)}
        .chat-m.a strong{font-weight:600;color:var(--ac)}.chat-m.a p{margin:5px 0}
        .chat-m.a ul,.chat-m.a ol{padding-left:18px;margin:5px 0}
        .chat-m.a li{margin:3px 0}.chat-m.a code{font-family:var(--fm);background:var(--ac-bg);color:var(--ac);padding:2px 6px;border-radius:4px;font-size:12px}
        .chat-m.a h3,.chat-m.a h4{font-size:14px;font-weight:700;margin:8px 0 4px;color:var(--bk)}
        .typing span{display:inline-block;width:6px;height:6px;background:var(--ac2);border-radius:50%;margin:0 2px;animation:bo 1.2s infinite}
        .typing span:nth-child(2){animation-delay:.15s}.typing span:nth-child(3){animation-delay:.3s}
        @keyframes bo{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
        .chips{display:flex;flex-wrap:wrap;gap:6px;padding:4px 20px 8px;flex-shrink:0}
        .chip{background:var(--wh);border:1.5px solid var(--ln);border-radius:20px;padding:7px 14px;
            font-size:11px;font-weight:500;color:var(--dk);cursor:pointer;transition:all .15s;white-space:nowrap}
        .chip:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-bg)}
        .chat-ia{display:flex;gap:8px;padding:12px 20px 28px;border-top:1px solid var(--ln);flex-shrink:0;background:var(--wh)}
        .chat-ia input{flex:1;background:var(--ft);border:1.5px solid var(--ln);border-radius:24px;padding:11px 18px;
            font-size:14px;font-family:var(--fb);color:var(--bk);outline:none;transition:all .2s}
        .chat-ia input:focus{border-color:var(--ac);box-shadow:0 0 0 3px rgba(108,99,255,.1)}
        .chat-ia input::placeholder{color:var(--soft)}
        .send-b{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--ac),var(--ac2));
            border:none;color:var(--wh);font-size:18px;cursor:pointer;flex-shrink:0;
            display:flex;align-items:center;justify-content:center;transition:all .15s;box-shadow:var(--glow)}
        .send-b:hover{transform:scale(1.08)}.send-b:disabled{background:var(--ln);box-shadow:none}

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ‘ãƒãƒ« */
        .mode-panel{padding:10px 16px;border-bottom:1px solid var(--ln);background:var(--ft);flex-shrink:0;display:flex;flex-direction:column;gap:7px}
        .mode-row{display:flex;align-items:center;gap:8px}
        .mode-row-toggle{justify-content:space-between}
        .mode-label{font-family:var(--fm);font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--soft);white-space:nowrap;min-width:32px}
        .mode-btns{display:flex;gap:4px;flex-wrap:wrap}
        .mode-btn{font-size:11px;font-family:var(--fb);font-weight:500;padding:4px 11px;
            border:1.5px solid var(--ln);border-radius:20px;background:var(--wh);
            color:var(--mid);cursor:pointer;transition:all .15s;white-space:nowrap}
        .mode-btn:hover{border-color:var(--ac2);color:var(--ac)}
        .mode-btn.mode-active{background:var(--ac);color:var(--wh);border-color:var(--ac);box-shadow:var(--glow)}
        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .toggle-wrap{position:relative;display:inline-block;width:40px;height:22px;flex-shrink:0}
        .toggle-wrap input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;inset:0;background:var(--ln);border-radius:22px;cursor:pointer;transition:background .2s}
        .toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:var(--wh);border-radius:50%;transition:transform .2s;box-shadow:var(--shadow-sm)}
        .toggle-wrap input:checked + .toggle-slider{background:var(--ac);box-shadow:var(--glow)}
        .toggle-wrap input:checked + .toggle-slider::before{transform:translateX(18px)}

        /* FABs */
        .fab-row{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);display:none;gap:10px;z-index:150}
        .fab-row.vis{display:flex;animation:fi .3s}
        .fab{height:48px;border-radius:24px;border:none;font-family:var(--fd);font-weight:700;font-size:13px;
            cursor:pointer;display:flex;align-items:center;gap:8px;padding:0 22px;transition:all .2s;box-shadow:var(--shadow-md)}
        .fab:hover{transform:translateY(-3px)}
        .fab-dk{background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);box-shadow:var(--glow),var(--shadow-md)}
        .fab-lt{background:var(--wh);color:var(--bk);border:1.5px solid var(--ln)}
        .fab-lt:hover{border-color:var(--ac);color:var(--ac)}

        /* Toast */
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);
            background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            padding:12px 24px;border-radius:50px;font-size:13px;font-weight:600;z-index:400;
            transition:transform .3s cubic-bezier(.22,1,.36,1);white-space:nowrap;box-shadow:var(--glow)}
        .toast.show{transform:translateX(-50%) translateY(0)}

        .spacer{height:100px}

        /* å¼±ç‚¹ãƒˆãƒ©ãƒƒã‚«ãƒ¼ */
        .weak-section{margin-top:24px;background:var(--wh);border-radius:18px;padding:18px 18px 14px;box-shadow:var(--shadow-sm);border:1.5px solid var(--ln)}
        .weak-title{font-family:var(--fd);font-weight:700;font-size:14px;letter-spacing:-.01em;margin-bottom:14px;display:flex;align-items:center;gap:6px}
        .weak-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--ft)}
        .weak-item:last-of-type{border-bottom:none}
        .weak-rank{font-size:18px;flex-shrink:0}
        .weak-info{flex:1;min-width:0}
        .weak-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
        .weak-bar-wrap{background:var(--ft);border-radius:4px;height:5px;overflow:hidden}
        .weak-bar{background:linear-gradient(90deg,var(--red),#ff8a93);height:100%;border-radius:4px;transition:width .6s cubic-bezier(.22,1,.36,1)}
        .weak-pct{font-family:var(--fm);font-size:11px;font-weight:600;color:var(--red);text-align:center;flex-shrink:0;line-height:1.3}
        .weak-pct small{font-size:9px;color:var(--mid);font-weight:400}
        .weak-empty{font-size:12px;color:var(--soft);padding:4px 0 8px}
        .weak-reset-btn{margin-top:10px;font-size:10px;font-family:var(--fm);letter-spacing:.1em;color:var(--soft);background:none;border:none;cursor:pointer;padding:0}
        .weak-reset-btn:hover{color:var(--red)}

        @media(max-width:640px){.shell{padding:0 16px}.header{padding:28px 0 8px}.header-logo{font-size:26px}.quiz-q{font-size:17px}.chat-ms{max-height:32vh}}
        ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--ac2);border-radius:3px;opacity:.5}
    </style>
</head>
<body>

<div class="shell">
    <!-- MAIN SCREEN -->
    <div id="mainScreen" class="screen">
        <div class="header">
            <div class="header-logo">Quick Quiz<span class="ai">AI</span></div>
            <div class="header-sub">JUKEN CAMP Ã— AI</div>
            <div class="header-line"></div>
        </div>
        <!-- å¼±ç‚¹ãƒˆãƒ©ãƒƒã‚«ãƒ¼ -->
        <div class="weak-section">
            <div class="weak-title">ğŸ“Š ã‚ãªãŸã®å¼±ç‚¹TOP3</div>
            <div id="weakTopList"><p class="weak-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‚ˆã€‚å•é¡Œã‚’è§£ã„ã¦ã¿ã‚ˆã†ï¼</p></div>
            <button class="weak-reset-btn" onclick="if(confirm('å¼±ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){weakTracker={};saveTracker();renderWeakTop();}">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div style="margin-top:20px">
            <div class="label">Select Subject</div>
            <div class="subj-grid">
                <button class="subj-item" data-subject="social"><div class="subj-icon"><span>ğŸŒ</span></div><div class="subj-text">ç¤¾ä¼š</div><div class="subj-arrow">â†’</div></button>
                <button class="subj-item" data-subject="science"><div class="subj-icon"><span>ğŸ”¬</span></div><div class="subj-text">ç†ç§‘</div><div class="subj-arrow">â†’</div></button>
                <button class="subj-item" data-subject="english"><div class="subj-icon"><span>ğŸ“–</span></div><div class="subj-text">è‹±èª</div><div class="subj-arrow">â†’</div></button>
            </div>
        </div>
        <div class="spacer"></div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen hidden">
        <div class="header">
            <div class="header-logo">Quick Quiz<span class="ai">AI</span></div>
            <div class="header-sub">JUKEN CAMP Ã— AI</div>
            <div class="header-line"></div>
        </div>
        <div id="currentCategory" style="font-family:var(--fd);font-weight:700;font-size:18px;margin-top:24px;letter-spacing:-.02em"></div>
        <div class="stats-row">
            <div class="stat-cell"><div class="stat-num" id="correctCount">0</div><div class="stat-label">Correct</div></div>
            <div class="stat-cell"><div class="stat-num" id="wrongCount">0</div><div class="stat-label">Wrong</div></div>
            <div class="stat-cell"><div class="stat-num" id="totalCount">0</div><div class="stat-label">Total</div></div>
        </div>
        <div class="label">Mode</div>
        <div class="mode-row">
            <button id="randomModeBtn" class="mode-btn active">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
            <button id="sequentialModeBtn" class="mode-btn">ğŸ“‹ é †ç•ªé€šã‚Š</button>
        </div>
        <button id="startQuizButton" class="btn btn-bk btn-full" style="margin-top:24px">ã‚¹ã‚¿ãƒ¼ãƒˆ â†’</button>
        <div class="spacer"></div>
    </div>
</div>

<!-- SUB-SUBJECT OVERLAYS -->
<div id="socialModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸŒ ç¤¾ä¼š</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="geography"><div class="subj-icon">ğŸ—ºï¸</div><div class="subj-text">åœ°ç†</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="history"><div class="subj-icon">ğŸ›ï¸</div><div class="subj-text">æ­´å²</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="civics"><div class="subj-icon">âš–ï¸</div><div class="subj-text">å…¬æ°‘</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<div id="scienceModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ”¬ ç†ç§‘</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="chemistry"><div class="subj-icon">ğŸ§ª</div><div class="subj-text">åŒ–å­¦</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="biology"><div class="subj-icon">ğŸ§¬</div><div class="subj-text">ç”Ÿç‰©</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="physics"><div class="subj-icon">âš›ï¸</div><div class="subj-text">ç‰©ç†</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="earth"><div class="subj-icon">ğŸŒ</div><div class="subj-text">åœ°å­¦</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<div id="englishModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“– è‹±èª</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="english_words"><div class="subj-icon">ğŸ“</div><div class="subj-text">è‹±å˜èª</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="english_phrases"><div class="subj-icon">ğŸ’¬</div><div class="subj-text">è‹±ç†Ÿèª</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="english_grammar"><div class="subj-icon">ğŸ“˜</div><div class="subj-text">èªå½¢å¤‰åŒ–</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<!-- CATEGORY SELECTION OVERLAYS -->
<div id="geographyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ—ºï¸ åœ°ç†</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="geographyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startGeographyQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="historyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ›ï¸ æ­´å²</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="historyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startHistoryQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="civicsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">âš–ï¸ å…¬æ°‘</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="civicsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startCivicsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="chemistryModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ§ª åŒ–å­¦</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="chemistryCategories"></div><div style="margin-top:24px;text-align:center"><button id="startChemistryQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="biologyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ§¬ ç”Ÿç‰©</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="biologyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startBiologyQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="physicsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">âš›ï¸ ç‰©ç†</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="physicsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startPhysicsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="earthModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸŒ åœ°å­¦</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="earthCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEarthQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="englishWordsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“ è‹±å˜èª</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishWordsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishWordsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>
<div id="englishPhrasesModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ’¬ è‹±ç†Ÿèª</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishPhrasesCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishPhrasesQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>
<div id="englishGrammarModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“˜ èªå½¢å¤‰åŒ–</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishGrammarCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishGrammarQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>

<!-- QUIZ SCREEN -->
<div id="quizModal" class="quiz-ov">
    <div class="quiz-in">
        <div class="quiz-cnt" id="quizCounter">QUESTION</div>
        <div class="quiz-q" id="quizQ"></div>
        <div class="quiz-opts" id="quizOptions"></div>
        <div class="quiz-res" id="quizResult"><span id="quizMsg"></span></div>
        <div class="quiz-acts">
            <button id="quizNext" class="btn btn-bk" disabled>æ¬¡ã®å•é¡Œ â†’</button>
            <button id="quizBack" class="btn btn-ol">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<!-- FABs -->
<div class="fab-row" id="fabRow">
    <button class="fab fab-lt" id="fabBack">ğŸ“š æ•™ç§‘é¸æŠ</button>
    <button class="fab fab-dk" id="fabAI">âœ¨ AIã«è³ªå•</button>
</div>

<!-- AI CHAT -->
<div class="chat-bd" id="chatBd"></div>
<div class="chat-pn" id="chatPn">
    <div class="chat-hd">
        <div class="chat-tt">âœ¨ AI å­¦ç¿’ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
        <button class="chat-x" id="chatX">âœ•</button>
    </div>
    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ‘ãƒãƒ« -->
    <div class="mode-panel">
        <div class="mode-row">
            <span class="mode-label">å£èª¿</span>
            <div class="mode-btns">
                <button class="mode-btn" data-style="teacher">ğŸ§‘â€ğŸ« å…ˆç”Ÿ</button>
                <button class="mode-btn" data-style="friend">ğŸ¤™ å‹é”</button>
                <button class="mode-btn" data-style="exam">ğŸ“‹ è©¦é¨“å‘ã‘</button>
            </div>
        </div>
        <div class="mode-row">
            <span class="mode-label">æ·±ã•</span>
            <div class="mode-btns">
                <button class="mode-btn" data-depth="easy">ğŸŸ¢ ã‚„ã•ã—ã</button>
                <button class="mode-btn" data-depth="normal">ğŸŸ¡ ãµã¤ã†</button>
                <button class="mode-btn" data-depth="deep">ğŸ”´ æ·±ã</button>
            </div>
        </div>
        <div class="mode-row mode-row-toggle">
            <span class="mode-label">ä¸æ­£è§£ã§è‡ªå‹•åˆ†æ</span>
            <label class="toggle-wrap">
                <input type="checkbox" id="autoAnalyzeTog">
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>
    <div class="chat-ms" id="chatMs">
        <div class="chat-m a">ä½•ã§ã‚‚è³ªå•ã—ã¦ã­ï¼ã‚¯ã‚¤ã‚ºã®è§£èª¬ã‚’æ·±æ˜ã‚Šã—ãŸã‚Šã€ãƒ†ã‚¹ãƒˆã«å‡ºã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆã‚’èã„ãŸã‚Šã§ãã‚‹ã‚ˆ ğŸ“</div>
    </div>
    <div class="chips" id="chips"></div>
    <div class="chat-ia">
        <input type="text" id="chatIn" placeholder="è³ªå•ã‚’å…¥åŠ›..." autocomplete="off">
        <button class="send-b" id="chatSd">â¤</button>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* =============================================================
   QUIK QUIZ AI â€” Core Logic
   ============================================================= */

// ---- Sound ----
class SFX {
    constructor() { try { this.c = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
    t(f, d, v = 0.15, tp = 'sine') {
        if (!this.c) return;
        const o = this.c.createOscillator(), g = this.c.createGain();
        o.connect(g); g.connect(this.c.destination);
        o.frequency.setValueAtTime(f, this.c.currentTime); o.type = tp;
        g.gain.setValueAtTime(0, this.c.currentTime);
        g.gain.linearRampToValueAtTime(v, this.c.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, this.c.currentTime + d);
        o.start(); o.stop(this.c.currentTime + d);
    }
    click() { this.t(800, 0.06, 0.03, 'square'); }
    ok() { this.t(523, 0.1); setTimeout(() => this.t(659, 0.1), 100); setTimeout(() => this.t(784, 0.12), 200); }
    ng() { this.t(200, 0.2, 0.15, 'sawtooth'); }
    go() { [523, 587, 659, 784].forEach((f, i) => setTimeout(() => this.t(f, 0.1), i * 80)); }
}
const sfx = new SFX();
document.addEventListener('click', () => { if (sfx.c?.state === 'suspended') sfx.c.resume(); }, { once: true });

// ---- Voice ----
const voice = {
    enabled: true,
    speak(t) {
        if (!this.enabled || !t || !('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(t);
        const v = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en-'));
        if (v.length) { const s = v.find(v => v.name.toLowerCase().includes('samantha')) || v[0]; u.voice = s; u.lang = s.lang; }
        else u.lang = 'en-US';
        u.rate = 0.9; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }
};

// ---- Categories ----
const categories={geography:[{id:'geo_world_overview',name:'1.ä¸–ç•Œã®å§¿'},{id:'geo_japan_overview',name:'2.æ—¥æœ¬ã®å§¿'},{id:'geo_world_life',name:'3.ä¸–ç•Œå„åœ°ã®äººã€…ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},{id:'geo_asia',name:'4.ã‚¢ã‚¸ã‚¢å·'},{id:'geo_europe',name:'5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},{id:'geo_africa',name:'6.ã‚¢ãƒ•ãƒªã‚«å·'},{id:'geo_north_america',name:'7.åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_south_america',name:'8.å—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_oceania',name:'9.ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},{id:'geo_japan_features',name:'10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},{id:'geo_japan_kyushu',name:'11.ä¹å·åœ°æ–¹'},{id:'geo_japan_chugoku',name:'12.ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},{id:'geo_japan_kinki',name:'13.è¿‘ç•¿åœ°æ–¹'},{id:'geo_japan_chubu',name:'14.ä¸­éƒ¨åœ°æ–¹'},{id:'geo_japan_kanto',name:'15.é–¢æ±åœ°æ–¹'},{id:'geo_japan_tohoku',name:'16.æ±åŒ—åœ°æ–¹'},{id:'geo_japan_hokkaido',name:'17.åŒ—æµ·é“åœ°æ–¹'}],history:[{id:'hist_ancient',name:'1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬ã®æˆã‚Šç«‹ã¡'},{id:'hist_ancient_state',name:'2.å¤ä»£å›½å®¶ã®æ­©ã¿ã¨æ±ã‚¢ã‚¸ã‚¢'},{id:'hist_kamakura',name:'3.æ­¦å£«ã®ãŠã“ã‚Šã¨éŒå€‰å¹•åºœ'},{id:'hist_muromachi',name:'4.ãƒ¢ãƒ³ã‚´ãƒ«ã®è¥²æ¥ã¨å®¤ç”ºå¹•åºœ'},{id:'hist_unification',name:'5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘äººã¨ã®å‡ºä¼šã„ã¨å…¨å›½çµ±ä¸€'},{id:'hist_edo_early',name:'6.æ±Ÿæˆ¸å¹•åºœã®æˆç«‹ã¨é–å›½'},{id:'hist_edo_develop',name:'7.ç”£æ¥­ã®ç™ºé”ã¨å¹•åºœæ”¿æ²»ã®å±•é–‹'},{id:'hist_opening',name:'8.æ¬§ç±³ã®é€²å‡ºã¨æ—¥æœ¬ã®é–‹å›½'},{id:'hist_meiji',name:'9.æ˜æ²»ç¶­æ–°'},{id:'hist_wars',name:'10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰ã¨æ—¥æœ¬ã®ç”£æ¥­é©å‘½'},{id:'hist_wwi',name:'11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦ã¨æ—¥æœ¬'},{id:'hist_wwii',name:'12.ä¸–ç•Œææ…Œã¨ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},{id:'hist_postwar',name:'13.æˆ¦å¾Œã®æ—¥æœ¬ã®ç™ºå±•ã¨å›½éš›ç¤¾ä¼š'}],civics:[{id:'civics_modern',name:'1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},{id:'civics_constitution',name:'2.äººé–“ã®å°Šé‡ã¨æ—¥æœ¬å›½æ†²æ³•'},{id:'civics_democracy',name:'3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},{id:'civics_economy',name:'4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'}],chemistry:[{id:'chemistry_basic',name:'1.ç‰©è³ªã¨ãã®æ€§è³ª'},{id:'chemistry_gas',name:'2.æ°—ä½“ã®æ€§è³ª'},{id:'chemistry_solution',name:'3.æ°´æº¶æ¶²ã®æ€§è³ª'},{id:'chemistry_state',name:'4.çŠ¶æ…‹å¤‰åŒ–'},{id:'chemistry_change',name:'5.ç‰©è³ªã®å¤‰åŒ–'},{id:'chemistry_structure',name:'6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},{id:'chemistry_reaction',name:'7.ç‰©è³ªã©ã†ã—ã®åŒ–å­¦å¤‰åŒ–'},{id:'chemistry_mass',name:'8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},{id:'chemistry_ion',name:'9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},{id:'chemistry_acid',name:'10.é…¸ã€ã‚¢ãƒ«ã‚«ãƒªã€å¡©'},{id:'chemistry_formula',name:'11.åŒ–å­¦å¼'},{id:'chemistry_reaction_equation',name:'12.åŒ–å­¦åå¿œå¼'},{id:'chemistry_ion_formula',name:'13.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼'},{id:'chemistry_ion_reaction',name:'14.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦åå¿œå¼'}],biology:[{id:'biology_flower',name:'1.èŠ±ã®ã¤ãã‚Š'},{id:'biology_plant',name:'2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Š'},{id:'biology_animal',name:'3.å‹•ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},{id:'biology_microscope',name:'4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},{id:'biology_cell',name:'5.ç”Ÿç‰©ã¨ç´°èƒ'},{id:'biology_plant_body',name:'6.æ¤ç‰©ã®ã‹ã‚‰ã ã®ã¤ãã‚Š'},{id:'biology_digestion',name:'7.æ¶ˆåŒ–ã¨å¸å'},{id:'biology_breathing',name:'8.å‘¼å¸'},{id:'biology_circulation',name:'9.è¡€æ¶²ã®å¾ªç’°'},{id:'biology_response',name:'10.åˆºæ¿€ã¨åå¿œ'},{id:'biology_growth',name:'11.ç”Ÿç‰©ã®æˆé•·'},{id:'biology_reproduction',name:'12.ç”Ÿç‰©ã®ç”Ÿæ®–'},{id:'biology_heredity',name:'13.éºä¼ã®è¦å‰‡æ€§'},{id:'biology_evolution',name:'14.ç”Ÿç‰©ã®é€²åŒ–'},{id:'biology_environment',name:'15.è‡ªç„¶ã¨ç’°å¢ƒ'}],physics:[{id:'physics_light',name:'1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_sound',name:'2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_force',name:'3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_current',name:'4.é›»æµã¨é›»åœ§'},{id:'physics_energy',name:'5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},{id:'physics_magnetic',name:'6.é›»æµã¨ç£ç•Œ'},{id:'physics_balance',name:'7.åŠ›ã®ã¤ã‚Šåˆã„'},{id:'physics_motion',name:'8.ç‰©ä½“ã®é‹å‹•'},{id:'physics_pressure',name:'9.æ°´åœ§ã¨æµ®åŠ›'},{id:'physics_work',name:'10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},{id:'physics_energy_change',name:'11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},{id:'physics_resources',name:'12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æºã®åˆ©ç”¨'}],earth:[{id:'earth_volcano',name:'1.ç«å±±'},{id:'earth_earthquake',name:'2.åœ°éœ‡'},{id:'earth_strata',name:'3.åœ°å±¤ã®ã§ãæ–¹'},{id:'earth_weather',name:'4.æ°—è±¡ã®è¦³æ¸¬'},{id:'earth_front',name:'5.æ°—å›£ã¨å‰ç·š'},{id:'earth_cloud',name:'6.é›²ã®ã§ãæ–¹'},{id:'earth_celestial',name:'7.å¤©ä½“ã®å‹•ã'},{id:'earth_solar',name:'8.å¤ªé™½ç³»ã®å¤©ä½“'},{id:'earth_moon',name:'9.æœˆã¨æƒ‘æ˜Ÿã®è¦‹ãˆæ–¹'}],english_words:[{id:'words_time',name:'æœˆãƒ»åºæ•°'},{id:'words_week',name:'æ›œæ—¥'},{id:'words_timeday',name:'æ™‚ãƒ»æ™‚é–“å¸¯'},{id:'words_season',name:'å­£ç¯€ãƒ»å®¶æ—'},{id:'words_sports',name:'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},{id:'words_job',name:'è·æ¥­ãƒ»äººãƒ»å»ºç‰©'},{id:'words_uncountable',name:'æ•°ãˆã‚‰ã‚Œãªã„åè©'},{id:'words_verb_important',name:'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},{id:'words_verb_various',name:'ã„ã‚ã„ã‚ãªæ„å‘³ã‚’ã‚‚ã¤å‹•è©'},{id:'words_verb_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„å‹•è©'},{id:'words_verb_other',name:'ãã®ä»–ã®é‡è¦å‹•è©'},{id:'words_adj_quantity',name:'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},{id:'words_adj_various',name:'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},{id:'words_adj_adv',name:'ãã®ä»–ã®é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},{id:'words_adv_manner',name:'æ§˜å­ã‚’è¡¨ã™å‰¯è©'}],english_phrases:[{id:'phrases_verb',name:'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},{id:'phrases_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„ç†Ÿèª'},{id:'phrases_similar',name:'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},{id:'phrases_verb_other',name:'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},{id:'phrases_be',name:'be å‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},{id:'phrases_quantity',name:'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},{id:'phrases_time_place',name:'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},{id:'phrases_important',name:'ãã®ä»–ã®é‡è¦ç†Ÿèª'}],english_grammar:[{id:'grammar_irregular_past',name:'ä¸è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},{id:'grammar_irregular_same',name:'ä¸è¦å‰‡å‹•è© - éå»å½¢ã¨éå»åˆ†è©ãŒåŒã˜'},{id:'grammar_irregular_special',name:'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹'},{id:'grammar_be_past',name:'be å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},{id:'grammar_regular',name:'è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},{id:'grammar_third_person',name:'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},{id:'grammar_ing',name:'å‹•è©ã® -ing å½¢'},{id:'grammar_comparative',name:'å½¢å®¹è© - æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},{id:'grammar_more_most',name:'moreã€most ã‚’ã¤ã‘ã‚‹å½¢å®¹è©'},{id:'grammar_noun_plural',name:'åè©ã®è¤‡æ•°å½¢'},{id:'grammar_irregular_plural',name:'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},{id:'grammar_pronoun',name:'äººç§°ä»£åè©'}]};

const gradeMap={chemistry:{'ä¸­1':[0,4],'ä¸­2':[4,8],'ä¸­3':[8,10],'åŒ–å­¦å¼ãƒ»åå¿œå¼':[10,14]},biology:{'ä¸­1':[0,4],'ä¸­2':[4,10],'ä¸­3':[10,15]},physics:{'ä¸­1':[0,3],'ä¸­2':[3,6],'ä¸­3':[6,12]},earth:{'ä¸­1':[0,3],'ä¸­2':[3,6],'ä¸­3':[6,9]}};

// ---- State ----
let sel=[],cc=0,wc=0,tc=0,used=[],qMode='random',seqIdx=0,curSubj='',curLabel='',curQuiz=null;

function toast(t){const e=document.getElementById('toast');e.textContent=t;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),2200)}
function hideAll(){document.querySelectorAll('.overlay').forEach(m=>m.classList.remove('show'));document.getElementById('quizModal').classList.remove('show')}
function show(id){hideAll();document.getElementById(id).classList.add('show')}
function goBackToMain(){hideAll();sfx.click()}
function goBackToSocial(){show('socialModal');sfx.click()}
function goBackToScience(){show('scienceModal');sfx.click()}
function goBackToEnglish(){show('englishModal');sfx.click()}
function updateStats(){document.getElementById('correctCount').textContent=cc;document.getElementById('wrongCount').textContent=wc;document.getElementById('totalCount').textContent=tc}

function initCats(){
    ['geography','history','civics','english_words','english_phrases','english_grammar'].forEach(s=>{
        const c=document.getElementById(s.split('_').map((w,i)=>i?w[0].toUpperCase()+w.slice(1):w).join('')+'Categories');if(!c)return;
        categories[s].forEach(cat=>{const b=document.createElement('button');b.className='cat-item';b.textContent=cat.name;b.dataset.categoryId=cat.id;b.onclick=()=>togCat(s,cat.id,b);c.appendChild(b)});
    });
    Object.entries(gradeMap).forEach(([s,grades])=>{
        const c=document.getElementById(s+'Categories');if(!c)return;
        Object.entries(grades).forEach(([label,[start,end]])=>{const d=document.createElement('div');d.className='grade-div';d.textContent=label;c.appendChild(d);
            categories[s].slice(start,end).forEach(cat=>{const b=document.createElement('button');b.className='cat-item';b.textContent=cat.name;b.dataset.categoryId=cat.id;b.onclick=()=>togCat(s,cat.id,b);c.appendChild(b)})});
    });
}

function togCat(subj,id,btn){sfx.click();btn.classList.toggle('active');const i=sel.indexOf(id);if(i>-1)sel.splice(i,1);else sel.push(id);
    const sid='start'+subj.charAt(0).toUpperCase()+subj.slice(1).replace(/_(\w)/g,(_,c)=>c.toUpperCase())+'Quiz';const sb=document.getElementById(sid);if(sb)sb.disabled=sel.length===0}

function startQuiz(subj,label){sfx.go();curSubj=subj;curLabel=label;hideAll();
    document.getElementById('mainScreen').classList.add('hidden');document.getElementById('gameScreen').classList.remove('hidden');
    document.getElementById('currentCategory').textContent=label;document.getElementById('fabRow').classList.add('vis');
    cc=wc=tc=0;seqIdx=0;used=[];updateStats()}

function openQuiz(){const pool=[];sel.forEach(id=>{if(problemDatabase[id])pool.push(...problemDatabase[id])});
    if(!pool.length){toast('å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return}let q;
    if(qMode==='sequential'){if(seqIdx>=pool.length)seqIdx=0;q=pool[seqIdx];seqIdx++}
    else{const av=pool.filter(p=>!used.includes(p.q));if(!av.length){used=[];q=pool[Math.floor(Math.random()*pool.length)]}else q=av[Math.floor(Math.random()*av.length)];used.push(q.q)}
    curQuiz=q;showQuizUI(q)}

function showQuizUI(q){
    document.getElementById('quizCounter').textContent='QUESTION â€” '+curLabel;
    document.getElementById('quizQ').textContent=q.q;
    const od=document.getElementById('quizOptions');od.innerHTML='';
    const rs=document.getElementById('quizResult');rs.className='quiz-res';
    const mg=document.getElementById('quizMsg');mg.innerHTML='';
    const nb=document.getElementById('quizNext');nb.disabled=true;
    const isEng=sel.some(c=>c.startsWith('words_')||c.startsWith('phrases_')||c.startsWith('grammar_'));
    if(isEng)voice.speak(q.q);
    const sh=[...q.opts];const correctText=q.opts[q.ans];
    for(let i=sh.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[sh[i],sh[j]]=[sh[j],sh[i]]}
    const ci=sh.indexOf(correctText);const letters=['A','B','C','D'];
    let answered=false;
    sh.forEach((txt,i)=>{const b=document.createElement('button');b.className='quiz-opt';
        b.innerHTML='<span class="quiz-let">'+letters[i]+'</span><span>'+txt+'</span>';
        b.onclick=()=>{if(isEng)voice.speak(txt);
            if(!answered){answered=true;tc++;if(i===ci){cc++;sfx.ok();toast('ğŸ‰ æ­£è§£ï¼')}else{wc++;sfx.ng()}updateStats();nb.disabled=false}
            if(i===ci){mg.innerHTML='ğŸ‰ æ­£è§£ï¼ '+(q.exp||'');rs.className='quiz-res ok'}
            else{mg.innerHTML='âŒ ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ'+correctText+'ã€ '+(q.exp||'');rs.className='quiz-res ng'}
            updateChips()};od.appendChild(b)});
    nb.onclick=()=>{sfx.click();openQuiz()};
    document.getElementById('quizBack').onclick=()=>{sfx.click();hideAll()};
    show('quizModal');
}

// ---- AI Chat ----
function updateChips(){const el=document.getElementById('chips');el.innerHTML='';if(!curQuiz)return;
    const corr=curQuiz.opts[curQuiz.ans];
    ['ã€Œ'+corr+'ã€ã‚’ã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦','ã“ã®å•é¡Œã®è¦šãˆæ–¹ã®ã‚³ãƒ„ã¯ï¼Ÿ','å…¥è©¦ã§ã©ã†å‡ºé¡Œã•ã‚Œã‚‹ï¼Ÿ','é–¢é€£ã™ã‚‹é‡è¦ç”¨èªã‚’æ•™ãˆã¦'].forEach(t=>{
        const c=document.createElement('button');c.className='chip';c.textContent=t;c.onclick=()=>sendChat(t);el.appendChild(c)})}

function getCtx(){if(!curQuiz)return '';return 'å•é¡Œ: '+curQuiz.q+'\næ­£è§£: '+curQuiz.opts[curQuiz.ans]+'\nè§£èª¬: '+(curQuiz.exp||'ãªã—')+'\næ•™ç§‘: '+curLabel+'\né¸æŠè‚¢: '+curQuiz.opts.join(', ')}

function md2html(md){let h=md.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`(.+?)`/g,'<code>$1</code>').replace(/^### (.+)$/gm,'<h4>$1</h4>').replace(/^## (.+)$/gm,'<h3>$1</h3>').replace(/^- (.+)$/gm,'<li>$1</li>').replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>');h=h.replace(/((?:<li>.+<\/li>\n?)+)/g,'<ul>$1</ul>');h=h.split('\n\n').map(p=>{p=p.trim();if(!p||p.startsWith('<'))return p;return'<p>'+p+'</p>'}).join('');return h}

async function sendChat(message){if(!message.trim())return;
    const box=document.getElementById('chatMs'),inp=document.getElementById('chatIn'),btn=document.getElementById('chatSd');
    const ub=document.createElement('div');ub.className='chat-m u';ub.textContent=message;box.appendChild(ub);inp.value='';btn.disabled=true;
    const tb=document.createElement('div');tb.className='chat-m a';tb.innerHTML='<div class="typing"><span></span><span></span><span></span></div>';
    box.appendChild(tb);box.scrollTop=box.scrollHeight;
    if(!document.getElementById('chatPn').classList.contains('show')){document.getElementById('chatPn').classList.add('show');document.getElementById('chatBd').classList.add('show')}
    try{const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message,quizContext:getCtx()})});
        const d=await r.json();tb.innerHTML=md2html(d.reply||d.error||'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')}
    catch(e){tb.innerHTML='<p>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ã€‚</p>'}
    btn.disabled=false;box.scrollTop=box.scrollHeight}

// ---- Events ----
document.addEventListener('DOMContentLoaded',()=>{
    initCats();
    document.querySelectorAll('[data-subject]').forEach(b=>b.addEventListener('click',()=>{sfx.click();show(b.dataset.subject+'Modal')}));
    document.querySelectorAll('[data-category]').forEach(b=>b.addEventListener('click',()=>{sfx.click();sel=[];
        const mid=b.dataset.category.split('_').map((w,i)=>i?w[0].toUpperCase()+w.slice(1):w).join('')+'Modal';show(mid)}));
    const starts={startGeographyQuiz:['geography','ğŸ—ºï¸ åœ°ç†'],startHistoryQuiz:['history','ğŸ›ï¸ æ­´å²'],startCivicsQuiz:['civics','âš–ï¸ å…¬æ°‘'],startChemistryQuiz:['chemistry','ğŸ§ª åŒ–å­¦'],startBiologyQuiz:['biology','ğŸ§¬ ç”Ÿç‰©'],startPhysicsQuiz:['physics','âš›ï¸ ç‰©ç†'],startEarthQuiz:['earth','ğŸŒ åœ°å­¦'],startEnglishWordsQuiz:['english_words','ğŸ“ è‹±å˜èª'],startEnglishPhrasesQuiz:['english_phrases','ğŸ’¬ è‹±ç†Ÿèª'],startEnglishGrammarQuiz:['english_grammar','ğŸ“˜ èªå½¢å¤‰åŒ–']};
    Object.entries(starts).forEach(([id,[s,l]])=>{const el=document.getElementById(id);if(el)el.addEventListener('click',()=>startQuiz(s,l))});
    document.getElementById('startQuizButton').addEventListener('click',()=>{sfx.go();openQuiz()});
    document.getElementById('randomModeBtn').addEventListener('click',()=>{sfx.click();qMode='random';document.getElementById('randomModeBtn').classList.add('active');document.getElementById('sequentialModeBtn').classList.remove('active')});
    document.getElementById('sequentialModeBtn').addEventListener('click',()=>{sfx.click();qMode='sequential';document.getElementById('sequentialModeBtn').classList.add('active');document.getElementById('randomModeBtn').classList.remove('active')});
    document.getElementById('fabBack').addEventListener('click',()=>{sfx.click();sel=[];seqIdx=0;used=[];document.getElementById('gameScreen').classList.add('hidden');document.getElementById('mainScreen').classList.remove('hidden');document.getElementById('fabRow').classList.remove('vis');hideAll()});
    document.getElementById('fabAI').addEventListener('click',()=>{sfx.click();const p=document.getElementById('chatPn'),bg=document.getElementById('chatBd');if(p.classList.contains('show')){p.classList.remove('show');bg.classList.remove('show')}else{p.classList.add('show');bg.classList.add('show');updateChips()}});
    document.getElementById('chatX').addEventListener('click',()=>{document.getElementById('chatPn').classList.remove('show');document.getElementById('chatBd').classList.remove('show')});
    document.getElementById('chatBd').addEventListener('click',()=>{document.getElementById('chatPn').classList.remove('show');document.getElementById('chatBd').classList.remove('show')});
    document.getElementById('chatSd').addEventListener('click',()=>sendChat(document.getElementById('chatIn').value));
    document.getElementById('chatIn').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.isComposing)sendChat(document.getElementById('chatIn').value)});
});
</script>
</body>
</html>
